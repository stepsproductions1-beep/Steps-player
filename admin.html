<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>لوحة تحكم — Secure Admin (PBKDF2 + AES‑GCM)</title>
  <style>
    :root{--bg:#0b0f14;--card:#121821;--muted:#2a3442;--brand:#ff3b30;--text:#e7eef7;--text-dim:#a8b3c2}
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:#0b0f14;color:#e7eef7;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,sans-serif}
    .wrap{max-width:1100px;margin:0 auto;padding:24px}
    .card{background:#0f1620;border:1px solid #1f2937;border-radius:14px;box-shadow:0 10px 24px rgba(0,0,0,.25)}
    .header{display:flex;align-items:center;justify-content:space-between;padding:16px 18px;border-bottom:1px solid #1f2937}
    .title{margin:0;font-size:18px}
    .muted{color:#9fb0c5}
    .content{padding:18px}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .row3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px}
    label{display:block;margin-bottom:6px;color:#b6c2d2;font-size:13px}
    input[type="text"],input[type="url"],input[type="number"],input[type="password"],textarea{width:100%;padding:10px;border-radius:10px;border:1px solid #2a3442;background:#121a24;color:#e7eef7}
    input[type="color"]{width:48px;height:36px;border:1px solid #2a3442;border-radius:10px;background:#121a24}
    .btn{border:1px solid #2a3442;background:#18202b;color:#e7eef7;padding:10px 14px;border-radius:10px;cursor:pointer;font-weight:700}
    .btn.primary{background:var(--brand);border-color:transparent;color:#fff}
    .btn.danger{background:#b91c1c;border-color:#7f1d1d}
    .btnRow{display:flex;gap:8px;flex-wrap:wrap}
    .section{margin-bottom:16px}
    .notice{padding:10px 12px;background:#0b1320;border:1px dashed #26445f;border-radius:10px;color:#b6c2d2;font-size:13px}
    .auth{max-width:520px;margin:36px auto}
    .center{text-align:center}
    .hidden{display:none}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <div class="header">
        <h1 class="title">لوحة التحكّم — أمان عالي</h1>
        <div class="muted">PBKDF2 + AES‑GCM + JWT Gate</div>
      </div>
      <div class="content">
        <div id="authSetup" class="auth">
          <h3 class="center">إعداد كلمة مرور للمرّة الأولى</h3>
          <div class="section">
            <label>كلمة المرور الجديدة</label>
            <input id="setupPw1" type="password" placeholder="••••••••" autocomplete="new-password">
          </div>
          <div class="section">
            <label>تأكيد كلمة المرور</label>
            <input id="setupPw2" type="password" placeholder="••••••••" autocomplete="new-password">
          </div>
          <div class="btnRow center">
            <button id="btnSetPw" class="btn primary">حفظ كلمة المرور</button>
          </div>
          <div class="notice" style="margin-top:12px">هذه الحماية أمامية وتعتمد على المتصفح. لأمان مؤسسي، اربط الدومين بـ Cloudflare Access.</div>
        </div>

        <div id="authLogin" class="auth hidden">
          <h3 class="center">دخول لوحة التحكّم</h3>
          <div class="section">
            <label>كلمة المرور</label>
            <input id="loginPw" type="password" placeholder="••••••••" autocomplete="current-password">
          </div>
          <div class="btnRow center">
            <button id="btnLogin" class="btn primary">دخول</button>
            <button id="btnResetAuth" class="btn danger" title="مسح بيانات المصادقة فقط">مسح المصادقة</button>
          </div>
        </div>

        <div id="adminUI" class="hidden">
          <div class="section notice">
            • أنشئ/ارفع <code>publicKey.json</code> عبر <a href="tools.html" target="_blank" rel="noopener">tools.html</a>.<br>
            • اللاعب سيحمّل <code>config.public.json</code> إن وجد، وإلا يستخدم إعدادات مشفّرة من LocalStorage (يتطلب كلمة).
          </div>

          <div class="section row">
            <div>
              <label>اسم Main</label>
              <input id="cfgMainName" type="text" placeholder="Main" />
            </div>
            <div>
              <label>لون الأزرار</label>
              <input id="cfgBrand" type="color" value="#ff3b30" />
            </div>
          </div>
          <div class="section">
            <label>رابط Main (Vimeo)</label>
            <input id="cfgMainSrc" type="url" placeholder="https://vimeo.com/..." />
          </div>

          <div class="section">
            <label>الكاميرات</label>
            <div id="camsContainer"></div>
            <button id="btnAddCam" class="btn" type="button">+ إضافة كاميرا</button>
          </div>

          <div class="section row3">
            <div>
              <label>نسبة Main في التقسيم (%)</label>
              <input id="cfgSplitPct" type="number" min="30" max="70" step="1" value="50" />
            </div>
            <div>
              <label>عرض PiP في الوضع العادي (%)</label>
              <input id="cfgPipPct" type="number" min="15" max="40" step="1" value="28" />
            </div>
            <div>
              <label><input id="cfgDefaultSplit" type="checkbox" /> ابدأ في وضع التقسيم</label>
            </div>
          </div>

          <div class="section row">
            <div>
              <label>كلمة تشفير الإعدادات (للمشاهدين)</label>
              <input id="cfgEncPass" type="password" placeholder="Passphrase لفتح الإعدادات في Player" />
            </div>
            <div>
              <label>تكرارات PBKDF2</label>
              <input id="cfgPBKDF2Iter" type="number" value="310000" min="100000" step="1000" />
            </div>
          </div>

          <div class="btnRow">
            <button id="btnSaveEncrypted" class="btn primary">🔐 حفظ إعدادات مشفّرة (LocalStorage)</button>
            <button id="btnExportPublic" class="btn">⤴︎ تصدير config.public.json</button>
            <button id="btnImportPublic" class="btn">⤵︎ استيراد config.public.json</button>
            <button id="btnResetCfg" class="btn danger">↺ افتراضي</button>
            <a href="./" class="btn">↩︎ فتح صفحة المشاهدة</a>
            <span style="flex:1"></span>
            <button id="btnChangePw" class="btn">تغيير كلمة المرور</button>
            <button id="btnLogout" class="btn danger">تسجيل خروج</button>
          </div>

          <div class="section hidden" id="importArea">
            <label>الصق محتوى config.public.json هنا</label>
            <textarea id="importJSON" rows="6"></textarea>
          </div>
        </div>
      </div>
    </div>
  </div>

<script>
(function(){
  const LS_KEY_CFG_PLAIN = 'mc_config_v1';
  const LS_KEY_CFG_ENC   = 'mc_cfg_enc_v2';
  const LS_KEY_PW_HASH   = 'mc_admin_pw_hash_v2';
  const LS_KEY_PW_SALT   = 'mc_admin_pw_salt_v2';
  const PBKDF2_ITER_AUTH = 350000;

  const DEFAULT_CFG = {
    main: { name: 'Main', src: 'https://vimeo.com/event/5302696/embed/a4a7110029/interaction' },
    cams: [
      { name: 'كاميرا 2', src: 'https://player.vimeo.com/video/12345678' },
      { name: 'كاميرا 3', src: 'https://player.vimeo.com/video/23456789' },
      { name: 'كاميرا 4', src: 'https://player.vimeo.com/video/34567890' },
      { name: 'كاميرا 5', src: 'https://player.vimeo.com/video/45678901' },
      { name: 'كاميرا 6', src: 'https://player.vimeo.com/video/56789012' }
    ],
    brand: '#ff3b30', splitPct: 50, pipPct: 28, defaultSplit: false
  };

  const authSetup = document.getElementById('authSetup');
  const setupPw1 = document.getElementById('setupPw1');
  const setupPw2 = document.getElementById('setupPw2');
  const btnSetPw = document.getElementById('btnSetPw');
  const authLogin = document.getElementById('authLogin');
  const loginPw = document.getElementById('loginPw');
  const btnLogin = document.getElementById('btnLogin');
  const btnResetAuth = document.getElementById('btnResetAuth');

  const adminUI = document.getElementById('adminUI');
  const cfgMainName = document.getElementById('cfgMainName');
  const cfgMainSrc  = document.getElementById('cfgMainSrc');
  const cfgBrand    = document.getElementById('cfgBrand');
  const cfgSplitPct = document.getElementById('cfgSplitPct');
  const cfgPipPct   = document.getElementById('cfgPipPct');
  const cfgDefaultSplit = document.getElementById('cfgDefaultSplit');
  const cfgEncPass  = document.getElementById('cfgEncPass');
  const cfgPBKDF2Iter = document.getElementById('cfgPBKDF2Iter');
  const camsContainer = document.getElementById('camsContainer');
  const btnAddCam = document.getElementById('btnAddCam');
  const btnSaveEncrypted = document.getElementById('btnSaveEncrypted');
  const btnExportPublic = document.getElementById('btnExportPublic');
  const btnImportPublic = document.getElementById('btnImportPublic');
  const btnResetCfg = document.getElementById('btnResetCfg');
  const btnLogout = document.getElementById('btnLogout');
  const btnChangePw = document.getElementById('btnChangePw');
  const importArea = document.getElementById('importArea');
  const importJSON = document.getElementById('importJSON');

  const te = new TextEncoder(); const td = new TextDecoder();
  function b64url(bytes){ let bin=''; for(const b of new Uint8Array(bytes)) bin+=String.fromCharCode(b); return btoa(bin).replace(/\+/g,'-').replace(/\//g,'_').replace(/=+$/,''); }
  function b64urlToBytes(b64url){ const pad = '='.repeat((4-(b64url.length%4))%4); const b64=(b64url.replace(/-/g,'+').replace(/_/g,'/'))+pad; const bin=atob(b64); const out=new Uint8Array(bin.length); for(let i=0;i<bin.length;i++) out[i]=bin.charCodeAt(i); return out; }
  function genSalt(len=16){ const bytes=new Uint8Array(len); crypto.getRandomValues(bytes); return b64url(bytes); }

  function getCfg(){ try{ const raw = localStorage.getItem(LS_KEY_CFG_PLAIN); if(!raw) return JSON.parse(JSON.stringify(DEFAULT_CFG)); const parsed = JSON.parse(raw); return {...JSON.parse(JSON.stringify(DEFAULT_CFG)), ...parsed}; }catch(e){ return JSON.parse(JSON.stringify(DEFAULT_CFG)); } }
  function setCfgPlain(cfg){ localStorage.setItem(LS_KEY_CFG_PLAIN, JSON.stringify(cfg)); }

  async function pbkdf2Key(pass, saltBytes, iter, usage){
    const baseKey = await crypto.subtle.importKey('raw', te.encode(pass), 'PBKDF2', false, ['deriveKey','deriveBits']);
    if(usage==='auth'){
      const bits = await crypto.subtle.deriveBits({name:'PBKDF2', salt:saltBytes, iterations: iter, hash:'SHA-256'}, baseKey, 256);
      return Array.from(new Uint8Array(bits)).map(b=>b.toString(16).padStart(2,'0')).join('');
    } else {
      return crypto.subtle.deriveKey({name:'PBKDF2', salt:saltBytes, iterations: iter, hash:'SHA-256'}, baseKey, {name:'AES-GCM', length:256}, false, ['encrypt','decrypt']);
    }
  }

  function hasPassword(){ return !!localStorage.getItem(LS_KEY_PW_HASH); }
  function showSetup(){ authSetup.classList.remove('hidden'); authLogin.classList.add('hidden'); adminUI.classList.add('hidden'); }
  function showLogin(){ authSetup.classList.add('hidden'); authLogin.classList.remove('hidden'); adminUI.classList.add('hidden'); }
  function showAdmin(){ authSetup.classList.add('hidden'); authLogin.classList.add('hidden'); adminUI.classList.remove('hidden'); hydrateForm(); }

  btnSetPw.addEventListener('click', async ()=>{
    const p1 = setupPw1.value.trim(); const p2 = setupPw2.value.trim();
    if(!p1 || p1.length<8) return alert('الحد الأدنى 8 أحرف');
    if(p1!==p2) return alert('التأكيد غير مطابق');
    const salt = genSalt(16); const hashHex = await pbkdf2Key(p1, b64urlToBytes(salt), PBKDF2_ITER_AUTH, 'auth');
    localStorage.setItem(LS_KEY_PW_SALT, salt); localStorage.setItem(LS_KEY_PW_HASH, hashHex);
    setupPw1.value=setupPw2.value=''; showLogin(); alert('تم تعيين كلمة المرور. ادخل بها الآن.');
  });

  btnLogin.addEventListener('click', async ()=>{
    const salt = localStorage.getItem(LS_KEY_PW_SALT); const stored = localStorage.getItem(LS_KEY_PW_HASH);
    if(!salt || !stored){ return showSetup(); }
    const pw = loginPw.value.trim(); const hashHex = await pbkdf2Key(pw, b64urlToBytes(salt), PBKDF2_ITER_AUTH, 'auth');
    if(hashHex===stored){ loginPw.value=''; showAdmin(); } else { alert('كلمة المرور غير صحيحة'); }
  });

  btnResetAuth.addEventListener('click', ()=>{
    if(confirm('مسح بيانات المصادقة؟ سيُطلب إعداد كلمة مرور من جديد.')){
      localStorage.removeItem(LS_KEY_PW_HASH); localStorage.removeItem(LS_KEY_PW_SALT); showSetup();
    }
  });
  btnLogout.addEventListener('click', ()=>{ showLogin(); });
  btnChangePw.addEventListener('click', ()=>{
    if(confirm('تغيير كلمة المرور سيعيدك لواجهة الإعداد. متابعة؟')){
      localStorage.removeItem(LS_KEY_PW_HASH); localStorage.removeItem(LS_KEY_PW_SALT); showSetup();
    }
  });

  function hydrateForm(){
    const cfg = getCfg();
    document.documentElement.style.setProperty('--brand', cfg.brand||'#ff3b30');
    cfgMainName.value = cfg.main.name||'Main';
    cfgMainSrc.value  = cfg.main.src||'';
    cfgBrand.value    = cfg.brand||'#ff3b30';
    cfgSplitPct.value = cfg.splitPct||50;
    cfgPipPct.value   = cfg.pipPct||28;
    cfgDefaultSplit.checked = !!cfg.defaultSplit;
    renderCamsEditor(cfg);
  }
  function renderCamsEditor(cfg){
    camsContainer.innerHTML = '';
    cfg.cams.forEach((cam, idx)=> camsContainer.appendChild(camRow(cfg, idx, cam)) );
  }
  function camRow(cfg, idx, cam){
    const wrap = document.createElement('div');
    wrap.className = 'row'; wrap.style.marginBottom = '8px';
    wrap.innerHTML = `
      <div><label>اسم</label><input type="text" data-k="name" value="${cam.name||''}"></div>
      <div><label>رابط Vimeo</label><input type="url" data-k="src" value="${cam.src||''}"></div>
      <div style="grid-column:1 / span 2;display:flex;gap:8px">
        <button type="button" class="btn" data-act="up">↑ أعلى</button>
        <button type="button" class="btn" data-act="down">↓ أسفل</button>
        <button type="button" class="btn danger" data-act="del">حذف</button>
      </div>`;
    wrap.querySelectorAll('input').forEach(inp=>{
      inp.addEventListener('input', ()=>{
        const k = inp.getAttribute('data-k');
        const cur = getCfg();
        cur.cams[idx][k] = inp.value;
        setCfgPlain(cur);
      });
    });
    wrap.addEventListener('click', (e)=>{
      const act = e.target.getAttribute('data-act'); if(!act) return;
      const cur = getCfg();
      if (act==='del'){ cur.cams.splice(idx,1); setCfgPlain(cur); hydrateForm(); }
      if (act==='up' && idx>0){ const t = cur.cams[idx-1]; cur.cams[idx-1]=cur.cams[idx]; cur.cams[idx]=t; setCfgPlain(cur); hydrateForm(); }
      if (act==='down' && idx<cur.cams.length-1){ const t = cur.cams[idx+1]; cur.cams[idx+1]=cur.cams[idx]; cur.cams[idx]=t; setCfgPlain(cur); hydrateForm(); }
    });
    return wrap;
  }

  btnAddCam.addEventListener('click', ()=>{
    const cur = getCfg();
    cur.cams.push({name:'كاميرا جديدة', src:''});
    setCfgPlain(cur); hydrateForm();
  });

  btnImportPublic.addEventListener('click', ()=>{ importArea.classList.toggle('hidden'); });
  btnExportPublic.addEventListener('click', ()=>{
    const data = JSON.stringify(getCfg(), null, 2);
    const blob = new Blob([data], {type:'application/json'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = 'config.public.json';
    a.click();
    URL.revokeObjectURL(a.href);
  });
  btnResetCfg.addEventListener('click', ()=>{
    if(confirm('إرجاع الإعدادات الافتراضية؟')){ setCfgPlain(DEFAULT_CFG); hydrateForm(); }
  });

  btnSaveEncrypted.addEventListener('click', async ()=>{
    const pass = cfgEncPass.value.trim(); if(!pass || pass.length<6) return alert('ضع كلمة قوية لفك التشفير (6+ حروف)');
    const iter = Math.max(100000, Number(cfgPBKDF2Iter.value||310000));
    const cfg = getCfg();
    const salt = genSalt(16); const iv = genSalt(12);
    const baseKey = await crypto.subtle.importKey('raw', new TextEncoder().encode(pass), 'PBKDF2', false, ['deriveKey']);
    const key = await crypto.subtle.deriveKey({name:'PBKDF2', salt:b64urlToBytes(salt), iterations: iter, hash:'SHA-256'}, baseKey, {name:'AES-GCM', length:256}, false, ['encrypt','decrypt']);
    const data = new TextEncoder().encode(JSON.stringify(cfg));
    const enc = await crypto.subtle.encrypt({name:'AES-GCM', iv:b64urlToBytes(iv)}, key, data);
    const blob = { v:2, salt, iter, iv, data: b64url(enc) };
    localStorage.setItem(LS_KEY_CFG_ENC, JSON.stringify(blob));
    alert('تم الحفظ مشفّرًا في LocalStorage. في Player أدخل كلمة فك التشفير إذا لم تستخدم ملف config.public.json.');
  });

  (function init(){ if(!hasPassword()) showSetup(); else showLogin(); })();
})();
</script>
</body>
</html>
