<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Steps player </title>
  <style>
    :root{--bg:#0b0f14;--card:#121821;--muted:#2a3442;--brand:#ff3b30;--text:#e7eef7;--text-dim:#a8b3c2}
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,sans-serif}
    .wrap{width:100vw;height:100svh;margin:0}
    .player-card{width:100%;height:100%;background:transparent;border-radius:0;overflow:hidden}
    .video-area{position:relative;width:100%;height:100%;background:#000;overflow:hidden}

    /* الخلفية: الكاميرات المتبدّلة (Deck) */
    .iframeDeck{position:absolute;inset:0;overflow:hidden}
    .iframeDeck iframe{position:absolute;inset:0;width:100%;height:100%;border:0;opacity:0;visibility:hidden;transition:opacity .18s ease}
    .iframeDeck iframe.active{opacity:1;visibility:visible;z-index:1}
    .iframeDeck iframe.fading{opacity:0;visibility:visible;z-index:0;pointer-events:none}

    /* PiP (Main) — في الوضع العادي أعلى يمين، في وضع التقسيم يغطي النصف الأيمن */
    .pip{position:absolute;right:16px;top:16px;width:min(28%,420px);aspect-ratio:16/9;border:0;border-radius:0;overflow:hidden;box-shadow:none;background:transparent;z-index:2}
    .pip iframe{position:absolute;inset:0;width:100%;height:100%;border:0}
    .pip.hidden{display:none}

    /* وضع التقسيم */
    .video-area.split .pip{right:0;top:0;left:auto;bottom:0;width:50%;height:100%;aspect-ratio:auto;border:0;border-radius:0;box-shadow:none;z-index:1}
    .video-area.split #iframeDeck{left:0;right:50%;top:0;bottom:0;width:auto}

    /* عناصر التحكّم السفلية (للوضع العادي) */
    .controls{position:absolute;left:16px;right:16px;bottom:16px;display:flex;gap:8px;flex-wrap:wrap;z-index:3}
    .btn{border:1px solid var(--muted);background:#18202b;color:var(--text);padding:10px 14px;border-radius:10px;cursor:pointer;font-weight:600;transition:.2s}
    .btn:hover{border-color:#3a495f;transform:translateY(-1px)}
    .btn.active{background:var(--brand);border-color:transparent;color:#fff;box-shadow:0 6px 12px rgba(255,59,48,.35)}

    /* قائمة جانبية للأسماء في وضع التقسيم */
    .sideList{position:absolute;top:50%;left:16px;transform:translateY(-50%);display:none;flex-direction:column;gap:8px;z-index:4}
    .sideList .btn{min-width:140px;text-align:center}
    .video-area.split .sideList{display:flex}
    .video-area.split .controls{display:none}

    /* أزرار أعلى اليسار: الصوت + وضع التقسيم */
    .topLeft{position:absolute;left:16px;top:16px;z-index:4;display:flex;gap:8px;flex-wrap:wrap}
    .audioBtn, .splitBtn{border:1px solid var(--muted);background:#1b2531;color:var(--text);padding:8px 12px;border-radius:10px;cursor:pointer;font-weight:700}
    .audioBtn[aria-pressed="true"], .splitBtn[aria-pressed="true"]{background:var(--brand);color:#fff;border-color:transparent}

    /* معلومات */
    .meta{position:absolute;left:16px;top:60px;z-index:3;color:var(--text-dim);font-size:14px;background:rgba(0,0,0,.35);padding:6px 10px;border-radius:8px;backdrop-filter:blur(3px)}
    .badge{padding:2px 6px;border:1px solid var(--muted);border-radius:999px;margin-right:8px;color:#e7eef7}

    .tests{position:absolute;left:16px;top:100px;z-index:3;color:#a8b3c2;font-size:12px;background:rgba(0,0,0,.25);padding:6px 10px;border-radius:8px}
  </style>
</head>
<body>
<div class="wrap">
  <div class="player-card">
    <div class="video-area" id="videoArea">
      <!-- Deck (يشمل Main كعنصر 0) -->
      <div id="iframeDeck" class="iframeDeck" aria-live="polite"></div>

      <!-- PiP ثابت: MAIN (يصبح نصف الشاشة الأيمن في وضع التقسيم) -->
      <div class="pip" title="Main (الصوت الرئيسي)">
        <iframe id="mainIframe" src="about:blank" allow="autoplay; fullscreen; picture-in-picture; encrypted-media; web-share" allowfullscreen></iframe>
      </div>

      <!-- أزرار أعلى اليسار -->
      <div class="topLeft">
        <button id="audioBtn" class="audioBtn" type="button" aria-pressed="false" aria-label="تشغيل/إيقاف صوت Main">🔇 الصوت: متوقف</button>
        <button id="splitBtn" class="splitBtn" type="button" aria-pressed="false" aria-label="تبديل وضع تقسيم الشاشة">🞄🞄 تقسيم الشاشة</button>
      </div>

      <!-- Controls (أسفل) + قائمة جانبية للأسماء -->
      <div class="controls" id="camButtons" role="group" aria-label="التبديل بين الكاميرات"></div>
      <div class="sideList" id="sideList" role="group" aria-label="قائمة الكاميرات"></div>

      <div class="meta"><span class="badge" id="status">جاهز</span> الصوت من: <strong>Main</strong> — في وضع التقسيم: يمين = Main، يسار = الكاميرات المتبدلة، والأسماء على اليسار</div>
      <div class="tests" id="tests"></div>
    </div>
  </div>
</div>

<script src="https://player.vimeo.com/api/player.js"></script>
<script>
(function(){
  // ======== CONFIG ========
  const MAIN = { name: 'Main', src: 'https://vimeo.com/event/5304613/embed/interaction' };
  const CAMS = [
    { name: 'كاميرا 2', src: 'https://vimeo.com/event/5304570/embed/interaction' },
    { name: 'كاميرا 3', src: 'https://vimeo.com/event/5302696/embed/a4a7110029/interaction' },
    { name: 'كاميرا 4', src: 'https://player.vimeo.com/video/34567890' },
    { name: 'كاميرا 5', src: 'https://player.vimeo.com/video/45678901' },
    { name: 'كاميرا 6', src: 'https://player.vimeo.com/video/56789012' }
  ];
  const DECK = [MAIN, ...CAMS];

  // ======== Elements ========
  const videoArea = document.getElementById('videoArea');
  const mainIframe = document.getElementById('mainIframe');
  const pip = document.querySelector('.pip');
  const deck = document.getElementById('iframeDeck');
  const panel = document.getElementById('camButtons');
  const sideList = document.getElementById('sideList');
  const status = document.getElementById('status');
  const testsEl = document.getElementById('tests');
  const audioBtn = document.getElementById('audioBtn');
  const splitBtn = document.getElementById('splitBtn');

  // ======== State ========
  let currentBg = 0; // index داخل DECK
  let deckIframes = [];
  let mainPlayer = null;
  let audioArmed = false;
  let audioMuted = true; // يبدأ مكتوم
  let isSplit = false;   // وضع التقسيم

  // ======== Utils ========
  const qJoin = (obj)=> Object.entries(obj).map(([k,v])=>`${encodeURIComponent(k)}=${encodeURIComponent(v)}`).join('&');
  const withParams = (base, params)=> base + (base.includes('?')?'&':'?') + qJoin(params);
  const logStatus = (t)=> status.textContent = t;
  const setActiveButton = (i, container)=>{ [...container.children].forEach((b,idx)=> b.classList.toggle('active', idx===i)); };
  const applyPiPVisibility = ()=>{
    // في الوضع العادي: أخفِ PiP عندما الخلفية = Main (لمنع التكرار)
    // في وضع التقسيم: اجعل PiP مرئيًا دائمًا (هو نصف الشاشة الأيسر)
    const hideWhenMain = !isSplit && currentBg === 0;
    pip.classList.toggle('hidden', hideWhenMain);
  };
  const updateAudioUI = ()=>{
    audioBtn.setAttribute('aria-pressed', String(!audioMuted));
    audioBtn.textContent = audioMuted ? '🔇 الصوت: متوقف' : '🔊 الصوت: يعمل';
    audioBtn.dataset.muted = String(audioMuted);
  };

  function ensureMainPlayer(){ if (!mainPlayer) mainPlayer = new Vimeo.Player(mainIframe); }
  function ensureMainAudioOn(){ ensureMainPlayer(); mainPlayer.setMuted(false).then(()=>mainPlayer.play()).catch(()=>{}); audioMuted=false; updateAudioUI(); }
  function ensureMainAudioOff(){ ensureMainPlayer(); mainPlayer.setMuted(true).catch(()=>{}); audioMuted=true; updateAudioUI(); }

  // تبديل الخلفية (يمين الشاشة في وضع التقسيم)
  function switchBackground(i){
    if (i === currentBg) return;
    const cur = deckIframes[currentBg];
    const nxt = deckIframes[i];
    if (!nxt) return;
    if (cur){
      cur.classList.remove('active');
      cur.classList.add('fading');
      const cleanup = ()=>{ cur.classList.remove('fading'); cur.removeEventListener('transitionend', cleanup); };
      cur.addEventListener('transitionend', cleanup, {once:true});
      setTimeout(cleanup, 400);
    }
    nxt.classList.add('active');
    currentBg = i;
    applyPiPVisibility();
  }

  function buildMain(){
    const url = withParams(MAIN.src, { autoplay: 1, muted: 1, controls: 0, background: 1, playsinline: 1 });
    mainIframe.src = url;
    updateAudioUI();
  }

  function buildDeck(){
    deckIframes = DECK.map((cam, i)=>{
      const url = withParams(cam.src, { autoplay: 1, muted: 1, controls: 0, background: 1, playsinline: 1 });
      const f = document.createElement('iframe');
      f.src = url;
      f.setAttribute('allow','autoplay; fullscreen; picture-in-picture; encrypted-media; web-share');
      f.setAttribute('allowfullscreen','');
      f.setAttribute('loading','eager');
      if (i===0) f.classList.add('active');
      deck.appendChild(f);
      return f;
    });
  }

  function buildButtons(container){
    container.innerHTML = '';
    DECK.forEach((cam, i)=>{
      const btn = document.createElement('button');
      btn.className = 'btn' + (i===0 ? ' active' : '');
      btn.textContent = cam.name;
      btn.addEventListener('click', ()=>{
        btn.blur();
        if (!audioArmed && !audioMuted) { ensureMainAudioOn(); audioArmed = true; }
        switchBackground(i);
        setActiveButton(i, container);
        // حافظ على تزامن تمييز الأزرار بين القائمتين إن وُجدتا
        const other = (container===panel? sideList : panel);
        if (other && other.children[i]){
          [...other.children].forEach((b,idx)=> b.classList.toggle('active', idx===i));
        }
        logStatus('عرض: ' + DECK[i].name + (i===0?' (Main بالحجم الكامل — يمين في وضع التقسيم)':''));
      });
      container.appendChild(btn);
    });
  }

  function buildAudioToggle(){
    audioBtn.addEventListener('click', ()=>{
      if (audioMuted){ ensureMainAudioOn(); audioArmed = true; }
      else { ensureMainAudioOff(); }
    });
  }

  function buildSplitToggle(){
    splitBtn.addEventListener('click', ()=>{
      isSplit = !isSplit;
      splitBtn.setAttribute('aria-pressed', String(isSplit));
      applyLayout();
    });
  }

  function applyLayout(){
    videoArea.classList.toggle('split', isSplit);
    // إظهار القائمة الجانبية في وضع التقسيم وإخفاؤها في الوضع العادي
    sideList.style.display = isSplit ? 'flex' : 'none';
    panel.style.display    = isSplit ? 'none'  : 'flex';
    applyPiPVisibility();
  }

  // ======== Tests ========
  function runTests(){
    const errors = [];
    const assert = (c,m)=>{ if(!c) errors.push(m); };

    // T1: deck size == DECK length
    assert(deckIframes.length === DECK.length, `T1: deck ${deckIframes.length} != DECK ${DECK.length}`);

    // T2: exactly 1 active iframe (initial)
    let actives = deckIframes.filter(f=>f.classList.contains('active')).length;
    assert(actives === 1, `T2: expected 1 active background, got ${actives}`);

    // T3: main iframe set
    assert(mainIframe.src && mainIframe.src.startsWith('https://'), 'T3: main iframe not initialized');

    // T4: bottom buttons count == DECK length
    assert(panel.children.length === DECK.length, `T4: bottom buttons ${panel.children.length} != ${DECK.length}`);

    // T5: switching keeps one active
    const prev = currentBg;
    switchBackground((prev+1)%DECK.length);
    actives = deckIframes.filter(f=>f.classList.contains('active')).length;
    assert(actives === 1, `T5: expected 1 active after switch, got ${actives}`);

    // T6: PiP hidden only when not split AND background is Main
    const wasSplit = isSplit; isSplit=false; applyLayout();
    switchBackground(0);
    assert(pip.classList.contains('hidden'), 'T6a: PiP should be hidden when bg=Main and not split');
    switchBackground(1);
    assert(!pip.classList.contains('hidden'), 'T6b: PiP should be visible when bg!=Main and not split');

    // T7: Split mode shows sideList and keeps PiP visible
    isSplit=true; applyLayout();
    assert(videoArea.classList.contains('split'), 'T7a: split class not applied');
    assert(sideList.style.display==='flex', 'T7b: side list should be visible in split');
    assert(!pip.classList.contains('hidden'), 'T7c: PiP should be visible in split');

    // T8: side list buttons count == DECK length & sync active state
    assert(sideList.children.length === DECK.length, `T8: side buttons ${sideList.children.length} != ${DECK.length}`);
    sideList.children[2].click();
    const activeBottom = [...panel.children].filter(b=>b.classList.contains('active')).length;
    const activeSide   = [...sideList.children].filter(b=>b.classList.contains('active')).length;
    assert(activeBottom===1 && activeSide===1, 'T8b: active state not synced between lists');

    // T9: no extra 'fading' after a delay
    setTimeout(()=>{
      const fad = deckIframes.filter(f=>f.classList.contains('fading')).length;
      const final = errors.concat(
        fad===0?[]:[`T9: expected 0 fading, got ${fad}`]
      );
      testsEl.textContent = final.length ? ('Tests: FAILED — ' + final.join(' | ')) : 'Tests: PASSED';
      console[(final.length?'error':'log')](testsEl.textContent);
    }, 450);
  }

  // ======== Boot ========
  (function init(){
    const mainUrl = withParams(MAIN.src, { autoplay: 1, muted: 1, controls: 0, background: 1, playsinline: 1 });
    mainIframe.src = mainUrl;
    // Build UI
    buildDeck();
    buildButtons(panel);
    buildButtons(sideList);
    buildAudioToggle();
    buildSplitToggle();
    updateAudioUI();
    applyLayout();
    logStatus('تشغيل');
    setTimeout(runTests, 60);
  })();
})();
</script>
</body>
</html>
